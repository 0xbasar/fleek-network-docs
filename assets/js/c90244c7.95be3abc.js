"use strict";(self.webpackChunkdocta=self.webpackChunkdocta||[]).push([[4766],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>m});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(r),h=a,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||o;return r?n.createElement(m,l(l({ref:t},c),{},{components:r})):n.createElement(m,l({ref:t},c))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=h;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<o;p++)l[p]=r[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},2715:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var n=r(7462),a=(r(7294),r(3905)),o=r(3872);const l={template:"post",draft:!1,hide_title:!0,title:"How to migrate to Ursa proxy from NGINX",slug:"how-to-migrate-to-ursa-proxy-from-nginx",image:"./assets/fleek-network-migrate-to-ursa-proxy-from-nginx.png?202304271224",date:new Date("2023-04-27T23:00:00.000Z"),canonical:"",description:"Learn how to migrate to ursa-proxy from nginx",category:"Tutorial",tags:["Guide","Fleek Network","reverse-proxy","ursa-proxy","nginx"]},i=void 0,s={unversionedId:"Network nodes/fleek-network-how-to-migrate-to-ursa-proxy-from-nginx",id:"Network nodes/fleek-network-how-to-migrate-to-ursa-proxy-from-nginx",title:"How to migrate to Ursa proxy from NGINX",description:"Learn how to migrate to ursa-proxy from nginx",source:"@site/guides/Network nodes/fleek-network-how-to-migrate-to-ursa-proxy-from-nginx.md",sourceDirName:"Network nodes",slug:"/Network nodes/how-to-migrate-to-ursa-proxy-from-nginx",permalink:"/guides/Network nodes/how-to-migrate-to-ursa-proxy-from-nginx",draft:!1,editUrl:"https://github.com/fleek-network/fleek-network-docs/edit/main/guides/Network nodes/fleek-network-how-to-migrate-to-ursa-proxy-from-nginx.md",tags:[{label:"Guide",permalink:"/guides/tags/guide"},{label:"Fleek Network",permalink:"/guides/tags/fleek-network"},{label:"reverse-proxy",permalink:"/guides/tags/reverse-proxy"},{label:"ursa-proxy",permalink:"/guides/tags/ursa-proxy"},{label:"nginx",permalink:"/guides/tags/nginx"}],version:"current",lastUpdatedAt:1683114205,formattedLastUpdatedAt:"May 3, 2023",frontMatter:{template:"post",draft:!1,hide_title:!0,title:"How to migrate to Ursa proxy from NGINX",slug:"how-to-migrate-to-ursa-proxy-from-nginx",image:"./assets/fleek-network-migrate-to-ursa-proxy-from-nginx.png?202304271224",date:"2023-04-27T23:00:00.000Z",canonical:"",description:"Learn how to migrate to ursa-proxy from nginx",category:"Tutorial",tags:["Guide","Fleek Network","reverse-proxy","ursa-proxy","nginx"]},sidebar:"defaultSidebar",previous:{title:"How to install Rust and the dependencies for Ursa CLI",permalink:"/guides/Network nodes/fleek-network-how-to-install-rust-and-the-dependencies-for-ursa-cli"},next:{title:"Fleek Network: Managing the key store",permalink:"/guides/Network nodes/fleek-network-managing-the-key-store"}},p={image:r(8249).Z},c=[{value:"Introduction",id:"introduction",level:2},{value:"Docker stack",id:"docker-stack",level:2},{value:"Setup the Ursa proxy",id:"setup-the-ursa-proxy",level:3},{value:"1) Pull the latest version of the source code",id:"1-pull-the-latest-version-of-the-source-code",level:4},{value:"2) Update the Docker compose file",id:"2-update-the-docker-compose-file",level:4},{value:"3) Bind the host directories to the container",id:"3-bind-the-host-directories-to-the-container",level:4},{value:"4) Update the port numbers",id:"4-update-the-port-numbers",level:4},{value:"5) How the ursa-proxy configuration should look like",id:"5-how-the-ursa-proxy-configuration-should-look-like",level:4},{value:"Create the Ursa-proxy configuration file",id:"create-the-ursa-proxy-configuration-file",level:3},{value:"Generate the TLS Certificates",id:"generate-the-tls-certificates",level:3},{value:"1) Close any processes running on port 80",id:"1-close-any-processes-running-on-port-80",level:4},{value:"2) Stop the Docker stack",id:"2-stop-the-docker-stack",level:4},{value:"3) Confirm that the domain name is pointing to the server&#39;s public IP address",id:"3-confirm-that-the-domain-name-is-pointing-to-the-servers-public-ip-address",level:4},{value:"4) Create the certificates",id:"4-create-the-certificates",level:4},{value:"Quick health check",id:"quick-health-check",level:3},{value:"1) Start the Docker Stack services by running the Docker compose command",id:"1-start-the-docker-stack-services-by-running-the-docker-compose-command",level:4},{value:"2) Run a health check",id:"2-run-a-health-check",level:4},{value:"Native",id:"native",level:2},{value:"Setup the Ursa proxy",id:"setup-the-ursa-proxy-1",level:3},{value:"1) Pull the latest version of the source code",id:"1-pull-the-latest-version-of-the-source-code-1",level:4},{value:"Build the Ursa proxy from source",id:"build-the-ursa-proxy-from-source",level:3},{value:"Run the Ursa proxy install script",id:"run-the-ursa-proxy-install-script",level:4},{value:"Manual setup",id:"manual-setup",level:4},{value:"1) Run the install command",id:"1-run-the-install-command",level:4},{value:"2) Create a Systemd service for the Ursa proxy",id:"2-create-a-systemd-service-for-the-ursa-proxy",level:4},{value:"Create the Ursa proxy configuration",id:"create-the-ursa-proxy-configuration",level:3},{value:"1) Create the proxy directory where the config file for ursa-proxy will be:",id:"1-create-the-proxy-directory-where-the-config-file-for-ursa-proxy-will-be",level:4},{value:"2) Create the Ursa proxy <code>config.toml</code>:",id:"2-create-the-ursa-proxy-configtoml",level:4},{value:"Generate the TLS Certificates",id:"generate-the-tls-certificates-1",level:3},{value:"Run the Lets Encrypt install script",id:"run-the-lets-encrypt-install-script",level:4},{value:"Manual",id:"manual",level:4},{value:"1) Close any processes running on port 80",id:"1-close-any-processes-running-on-port-80-1",level:4},{value:"2) Confirm that the domain name is pointing to the server&#39;s public IP address",id:"2-confirm-that-the-domain-name-is-pointing-to-the-servers-public-ip-address",level:4},{value:"3) Create the certificates",id:"3-create-the-certificates",level:4},{value:"4) Start the Ursa proxy",id:"4-start-the-ursa-proxy",level:4},{value:"Quick health check",id:"quick-health-check-1",level:3},{value:"1) Check Ursa and Ursa Proxy services status",id:"1-check-ursa-and-ursa-proxy-services-status",level:4},{value:"2) Start the Ursa and Ursa-proxy services",id:"2-start-the-ursa-and-ursa-proxy-services",level:4},{value:"3) Run a health check",id:"3-run-a-health-check",level:4},{value:"Clear NGINX",id:"clear-nginx",level:3},{value:"Conclusion",id:"conclusion",level:2}],u={toc:c};function d(e){let{components:t,...l}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{src:r(8249).Z,width:"1200",height:"628"})),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"Many actors are free to communicate with your server, as Fleek Network encourages participation, but this comes with challenges, in terms of security, network resource availability, etc. To have a bit of control over the connections, a reverse proxy helps prevent users from connecting to the server processes directly, reducing the number of entry points and actions within the system."),(0,a.kt)("p",null,"On early builds, an NGINX service was included in the stack, fulfilling requirements and integrations simplicity. On the other hand, NGINX is a big project that offers features that are suitable for a wide range of use cases, which are not necessarily important for our goals, or particular use case."),(0,a.kt)("p",null,"We came up with the Ursa proxy, as a solution to replace NGINX, to provide us with a higher degree of control and customization to fit our service needs, such as mimicking the caching that NGINX does, SSL/TSL Certification, port mapping, etc."),(0,a.kt)("p",null,"In the following guide, we'll provide instructions to migrate from NGINX to the Ursa proxy."),(0,a.kt)("h2",{id:"docker-stack"},"Docker stack"),(0,a.kt)("p",null,"On earlier versions of our Docker stack, an NGINX service was included, as the reverse proxy for the Ursa service. Plus, required during the SSL/TLS certbot certification process to secure the domain name, relied on."),(0,a.kt)("p",null,"Since the Docker stack ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fleek-network/ursa/commit/258af75d5ad2e28f85fca908edbcb8062d927d3b"},"Ursa-proxy")," changes, and the related support added from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fleek-network/get.fleek.network/commit/0afa813ab74eaf15d50ad126d0534bbe0a14aed9"},"Ursa-proxy")," configuration in the assisted installer that the Ursa-proxy is now the default reverse proxy in the Docker stack."),(0,a.kt)("p",null,"If you have set up a node before these features, you'll have NGINX declared in your Docker stack configuration file."),(0,a.kt)("p",null,"We'll look into:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Setup the Ursa-proxy",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Pull the latest from source repository"),(0,a.kt)("li",{parentName:"ul"},"Update the Docker compose file",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Replace the NGINX service with the Ursa-proxy"),(0,a.kt)("li",{parentName:"ul"},"Bind the host directories to the container",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"The host machine ",(0,a.kt)("inlineCode",{parentName:"li"},".ursa")," configuration directory to the container"),(0,a.kt)("li",{parentName:"ul"},"A host machine directory to keep the Lets Encrypt TLS certificates, e.g. ",(0,a.kt)("inlineCode",{parentName:"li"},"~/fleek-network/ursa/data/certbot")))),(0,a.kt)("li",{parentName:"ul"},"Update the port numbers"))))),(0,a.kt)("li",{parentName:"ul"},"Create the Ursa-proxy configuration file"),(0,a.kt)("li",{parentName:"ul"},"Generate the TLS certifications"),(0,a.kt)("li",{parentName:"ul"},"Do a health check")),(0,a.kt)("h3",{id:"setup-the-ursa-proxy"},"Setup the Ursa proxy"),(0,a.kt)("p",null,"You'll modify the ",(0,a.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," to include the ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy"),". Change the directory to where the Ursa project is located, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("p",null,"\ud83d\udca1 Make sure you type the correct location of where you've saved the Ursa project source code"),(0,a.kt)("h4",{id:"1-pull-the-latest-version-of-the-source-code"},"1) Pull the latest version of the source code"),(0,a.kt)("p",null,"Switch to the main branch"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git checkout main\n")),(0,a.kt)("p",null,"Run the following command to pull the latest commits from ",(0,a.kt)("inlineCode",{parentName:"p"},"origin/main"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git pull origin main\n")),(0,a.kt)("p",null,"\u26a0\ufe0f If this fails, due to any of the possible several reasons, e.g. handling staged or local changes, having to discard changes, or saving changes, check the ",(0,a.kt)("a",{parentName:"p",href:"https://git-scm.com/doc"},"git documentation")," to learn the basics."),(0,a.kt)("h4",{id:"2-update-the-docker-compose-file"},"2) Update the Docker compose file"),(0,a.kt)("p",null,"Open the ",(0,a.kt)("inlineCode",{parentName:"p"},"./docker/full-node/docker-compose.yml")," in your favorite text editor."),(0,a.kt)("p",null,"Locate the NGINX service under ",(0,a.kt)("inlineCode",{parentName:"p"},"services"),". It should be similar to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'services:\n  nginx:\n    image: nginx:latest\n    restart: unless-stopped\n    command: "/bin/sh -c \'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \\"daemon off;\\"\'"\n    volumes:\n      - ./data/nginx:/etc/nginx/conf.d\n      - ./data/certbot/conf:/etc/letsencrypt\n      - ./data/certbot/www:/var/www/certbot\n      - ./data/nginx/cache:/cache:rw\n    ports:\n      - "80:80"\n      - "443:443"\n    expose:\n      - 80\n    depends_on:\n      - certbot\n')),(0,a.kt)("p",null,"Find and replace ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx.image")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy.image"),"."),(0,a.kt)("p",null,"From:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"nginx:\n  image: nginx:latest\n")),(0,a.kt)("p",null,"To the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ursa-proxy:\n  image: ghcr.io/fleek-network/ursa-proxy:latest\n")),(0,a.kt)("p",null,'Effectively, we are replacing the term "nginx" which is the Docker compose service name with the replacement service "ursa-proxy".'),(0,a.kt)("p",null,"\ud83d\udca1 While this prebuilt image ",(0,a.kt)("inlineCode",{parentName:"p"},"ghcr.io/fleek-network/ursa-proxy:latest")," should be suitable for most servers, it might not be supported by a wide range of vCPUs. If you find that the ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy")," fails to start, it's best to build from the source as that will create an image suitable for your server CPU architecture (errors that cause this are interrupted by signal 4: SIGILL, docker container exit status=132, etc). On the other hand, some users might just prefer to build the image from source code!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ursa-proxy:\n  image: ursa-proxy\n  build:\n    context: ../../.\n    dockerfile: Dockerfile-proxy\n")),(0,a.kt)("h4",{id:"3-bind-the-host-directories-to-the-container"},"3) Bind the host directories to the container"),(0,a.kt)("p",null,"Replace the ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy.volumes"),", or what was the ",(0,a.kt)("inlineCode",{parentName:"p"},"nginx.volumes")," from:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"volumes:\n  - ./data/nginx:/etc/nginx/conf.d\n  - ./data/certbot/conf:/etc/letsencrypt\n  - ./data/certbot/www:/var/www/certbot\n  - ./data/nginx/cache:/cache:rw\n")),(0,a.kt)("p",null,"To the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"volumes:\n  - ${HOME}/.ursa/:/root/.ursa/:rw\n  - ./data/certbot/conf:/etc/letsencrypt\n")),(0,a.kt)("h4",{id:"4-update-the-port-numbers"},"4) Update the port numbers"),(0,a.kt)("p",null,"Replace the port numbers from:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ports:\n  - 80:80\n  - 443:443\nexpose:\n  - 80\n")),(0,a.kt)("p",null,"To:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ports:\n  - 80:80\n  - 443:443\nexpose:\n  - 443\n")),(0,a.kt)("p",null,"\ud83d\udca1 We have the ",(0,a.kt)("inlineCode",{parentName:"p"},"ports")," bound to the host machine (HOST:CONTAINER), and the ",(0,a.kt)("inlineCode",{parentName:"p"},"expose"),' which defines which "exposes" ports to other services in the Docker network only'),(0,a.kt)("h4",{id:"5-how-the-ursa-proxy-configuration-should-look-like"},"5) How the ursa-proxy configuration should look like"),(0,a.kt)("p",null,"At this stage, the changes you've made for ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy")," should look like the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'services:\n  ursa-proxy:\n    image: ursa-proxy\n    build:\n      context: ../../.\n      dockerfile: Dockerfile-proxy\n    volumes:\n      - ${HOME}/.ursa/:/root/.ursa/:rw\n      - ./data/certbot/conf:/etc/letsencrypt\n    restart: unless-stopped\n    ports:\n      - "80:80"\n      - "443:443"\n    expose:\n      - 443\n    depends_on:\n      - certbot\n')),(0,a.kt)("h3",{id:"create-the-ursa-proxy-configuration-file"},"Create the Ursa-proxy configuration file"),(0,a.kt)("p",null,"We're going to assume that you're running the Docker stack with a system administrative user, such as a sudoer or root. This means that the ",(0,a.kt)("inlineCode",{parentName:"p"},".ursa")," directory will be located at:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"/root/.ursa\n")),(0,a.kt)("p",null,"If you have changed the way you run Docker and containers, such as we have described in ",(0,a.kt)("a",{parentName:"p",href:"./securing-the-ursa-files"},"Securing the Ursa files"),", then that'll be located at ",(0,a.kt)("inlineCode",{parentName:"p"},"$HOME/.ursa"),"."),(0,a.kt)("p",null,"For the case where the directory does not exist, you can create it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mkdir /root/.ursa\n")),(0,a.kt)("p",null,"Create the proxy directory where the config file for ursa-proxy will be:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mkdir /root/.ursa/proxy\n")),(0,a.kt)("p",null,"Create the Ursa proxy ",(0,a.kt)("inlineCode",{parentName:"p"},"config.toml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"touch /root/.ursa/proxy/config.toml\n")),(0,a.kt)("p",null,"Put the following content in the ",(0,a.kt)("inlineCode",{parentName:"p"},"config.toml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'# Server without TLS.\n[[server]]\nproxy_pass = "full-node-ursa-1:4069"\nlisten_addr = "0.0.0.0:80"\nserve_dir_path = ".well-known"\n\n# Server with TLS\n[[server]]\nproxy_pass = "full-node-ursa-1:4069"\nlisten_addr = "0.0.0.0:443"\n\n[server.tls]\ncert_path = "/etc/letsencrypt/live/YOUR-DOMAIN/fullchain.pem"\nkey_path = "/etc/letsencrypt/live/YOUR-DOMAIN/privkey.pem"\n\n# Admin service.\n# You can omit this section as this is the default.\n[admin]\naddr = "0.0.0.0:8881"\n')),(0,a.kt)("p",null,"Find and replace ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR-DOMAIN")," with your domain name. That'll be the values for the property ",(0,a.kt)("inlineCode",{parentName:"p"},"cert_path")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"key_path"),", e.g. let's say that your domain name is ",(0,a.kt)("inlineCode",{parentName:"p"},"node.domain.com"),", you'd replace ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR-DOMAIN")," to have:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'[server.tls]\ncert_path = "/etc/letsencrypt/live/node.domain.com/fullchain.pem"\nkey_path = "/etc/letsencrypt/live/node.domain.com/privkey.pem"\n')),(0,a.kt)("h3",{id:"generate-the-tls-certificates"},"Generate the TLS Certificates"),(0,a.kt)("p",null,"Change the directory to where the Ursa project is located, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("h4",{id:"1-close-any-processes-running-on-port-80"},"1) Close any processes running on port 80"),(0,a.kt)("p",null,"Find the PID of processes"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"lsof -i :80\n")),(0,a.kt)("p",null,"If port 80 is in use, you'll get a table similar to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"COMMAND PID   USER   FD   TYPE  DEVICE  SIZE/OFF  NODE NAME\nfoobar  88493 root   11u  IPv4  6545735      0t0  TCP  *:http (LISTEN)\n")),(0,a.kt)("p",null,"Stop the process by name of PID"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"kill -9 <PID>\n")),(0,a.kt)("p",null,"\ud83d\udca1 Replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<PID>")," with the numerical value that corresponds to the process"),(0,a.kt)("p",null,"For example, given the table result the PID is 88493"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"kill -9 88493\n")),(0,a.kt)("p",null,"To complete, confirm there aren't any processes running on port 80 by running the command again"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"lsof -i :80\n")),(0,a.kt)("p",null,"The response should be empty!"),(0,a.kt)("h4",{id:"2-stop-the-docker-stack"},"2) Stop the Docker stack"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"docker compose -f ./docker/full-node/docker-compose.yml down\n")),(0,a.kt)("h4",{id:"3-confirm-that-the-domain-name-is-pointing-to-the-servers-public-ip-address"},"3) Confirm that the domain name is pointing to the server's public IP address"),(0,a.kt)("p",null,"We are assuming that you have your domain name pointing to the server public IP address since you are migrating NGINX to Ursa-proxy. But if you're at the same time changing the domain name address that points to your server, or haven't done it, you have to open the domain name registrar dashboard and update the record type A records and set the domain name to respond with the server public IP Address."),(0,a.kt)("p",null,"For example, let's say that your domain name is ",(0,a.kt)("inlineCode",{parentName:"p"},"node.example.com")," and your server's public IP address is ",(0,a.kt)("inlineCode",{parentName:"p"},"181.196.118.156"),", this is how it'd look hypothetically:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Type"),(0,a.kt)("th",{parentName:"tr",align:null},"Host"),(0,a.kt)("th",{parentName:"tr",align:null},"Answer"),(0,a.kt)("th",{parentName:"tr",align:null},"TTL"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"A"),(0,a.kt)("td",{parentName:"tr",align:null},"node.example.com"),(0,a.kt)("td",{parentName:"tr",align:null},"181.196.118.156"),(0,a.kt)("td",{parentName:"tr",align:null},"300")))),(0,a.kt)("p",null,"Once you have ",(0,a.kt)("a",{parentName:"p",href:"#how-to-set-up-the-dns-settings-for-a-node-server"},"set up the DNS records"),", verify the records are set correctly, for that you can easily run ",(0,a.kt)("inlineCode",{parentName:"p"},"dig")," CLI or a website like ",(0,a.kt)("a",{parentName:"p",href:"https://mxtoolbox.com/"},"mxtoolbox"),"](",(0,a.kt)("a",{parentName:"p",href:"https://mxtoolbox.com/"},"https://mxtoolbox.com/"),")."),(0,a.kt)("p",null,"For our example, we're going to use the ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Dig_(command)"},"dig")," CLI."),(0,a.kt)("p",null,"\ud83d\udca1 If you don't have ",(0,a.kt)("inlineCode",{parentName:"p"},"dig")," installed, you can use your operating system package manager to install it, e.g. in Ubuntu you can run ",(0,a.kt)("inlineCode",{parentName:"p"},"apt-get install dig")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"dig node.example.com +nostats +nocomments +nocmd\n")),(0,a.kt)("p",null,"In the response, we get the IP address 181.196.118.156, as declared in the domain name registrar dashboard. Be aware that DNS propagation may take some time, if you need help troubleshooting check our reference ",(0,a.kt)("a",{parentName:"p",href:"../../reference/DNS/domain-name-system-nameserver-troubleshooting"},"DNS troubleshooting"),". "),(0,a.kt)("p",null,"\u26a0\ufe0f Your server DNS resolver, should get the correct data otherwise the certification process will fail!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},";node.example.com.      IN  A\nnode.example.com.       484 IN  A   181.196.118.156\n")),(0,a.kt)("p",null,"There are many other tools you can use to verify the DNS records, feel free to pick your favorite!"),(0,a.kt)("h4",{id:"4-create-the-certificates"},"4) Create the certificates"),(0,a.kt)("p",null,"Execute the command which will start a standalone web server on port 80 of your host."),(0,a.kt)("p",null,"\ud83d\udca1 Find and replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<YOUR-VALID-EMAIL-ADDRESS>")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"<YOUR-VALID-DOMAIN-NAME>")," with your email address and domain name. The email address is for administration purposes by ",(0,a.kt)("a",{parentName:"p",href:"https://letsencrypt.org/"},"Let's Encrypt org"),", we don't store any of your data."),(0,a.kt)("p",null,'We\'re using backslashes "\\" to break the lines to make it easier to read, you can ignore them.'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'docker compose -f ./docker/full-node/docker-compose.yml run \\\n  -p 80:80 \\\n  --rm --entrypoint "\\\n  certbot certonly \\\n    --standalone \\\n    --preferred-challenges http \\\n    --email <YOUR-VALID-EMAIL-ADDRESS> \\\n    --domain <YOUR-VALID-DOMAIN-NAME> \\\n    --rsa-key-size 4096 \\\n    --agree-tos -n" certbot\n')),(0,a.kt)("p",null,"For example, let's say that your email address is ",(0,a.kt)("inlineCode",{parentName:"p"},"skywalker@example.com")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"node.example.com"),", this is what it'd look like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'docker compose -f ./docker/full-node/docker-compose.yml run \\\n  -p 80:80 \\\n  --rm --entrypoint "\\\n  certbot certonly \\\n    --standalone \\\n    --preferred-challenges http \\\n    --email skywalker@example.com \\\n    --domain node.example.com \\\n    --rsa-key-size 4096 \\\n    --agree-tos -n" certbot\n')),(0,a.kt)("p",null,'Once executed and if all goes well, you should get a "success" message similar to:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"Domains: node.example.com\nCreating full-node_certbot_run ... done\nGenerating a RSA private key\n...........................................++++\n......................................................................................................................................................................................................++++\nwriting new private key to '/etc/letsencrypt/live/node.example.com/privkey.pem'\n-----\n\nCreating full-node_certbot_run ... done\nSaving debug log to /var/log/letsencrypt/letsencrypt.log\nRequesting a certificate for node.example.com\n\nSuccessfully received certificate.\nCertificate is saved at: /etc/letsencrypt/live/node.example.com/fullchain.pem\nKey is saved at:         /etc/letsencrypt/live/node.example.com/privkey.pem\nThis certificate expires on 2023-04-25.\nThese files will be updated when the certificate renews.\n\nNEXT STEPS:\n- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to enable that functionality. See https://certbot.org/renewal-setup for instructions.\n\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nIf you like Certbot, please consider supporting our work by:\n * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate\n * Donating to EFF:                    https://eff.org/donate-le\n")),(0,a.kt)("p",null,'\ud83d\udca1 Notice the "Successfully received certificate", where it\'s saved at "/etc/letsencrypt/live/node.example.com", the "This certificate expires on 2023-04-25" and any other details you might find interesting.'),(0,a.kt)("h3",{id:"quick-health-check"},"Quick health check"),(0,a.kt)("p",null,"The working directory should be the Ursa project source code location, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("h4",{id:"1-start-the-docker-stack-services-by-running-the-docker-compose-command"},"1) Start the Docker Stack services by running the Docker compose command"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"docker compose -f ./docker/full-node/docker-compose.yml up\n")),(0,a.kt)("h4",{id:"2-run-a-health-check"},"2) Run a health check"),(0,a.kt)("p",null,"As instructed in the ",(0,a.kt)("a",{parentName:"p",href:"fleek-network-node-health-check-guide"},"guide"),", we can do a quick health check by making ",(0,a.kt)("inlineCode",{parentName:"p"},"cURL")," requests to our server and reading the response. There's the option to get the response body that should be text ",(0,a.kt)("inlineCode",{parentName:"p"},"pong")," or get some HTTP Headers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'curl -w "\\n" https://<YOUR DOMAIN NAME>/ping\n')),(0,a.kt)("p",null,"For our example, we have the domain ",(0,a.kt)("inlineCode",{parentName:"p"},"node.domain.com")," and this is how the ",(0,a.kt)("inlineCode",{parentName:"p"},"cURL")," request would look like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'curl -w "\\n" https://node.domain.com/ping\n')),(0,a.kt)("p",null,"A successful response should be ",(0,a.kt)("inlineCode",{parentName:"p"},"pong")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"pong\n")),(0,a.kt)("p",null,"Use the flag ",(0,a.kt)("inlineCode",{parentName:"p"},"-I")," to get the HTTP Headers. To learn more read the guide ",(0,a.kt)("a",{parentName:"p",href:"fleek-network-node-health-check-guide"},"here"),"."),(0,a.kt)("p",null,"You can do these tests from any remote location that is not your server or local machine and the health check should pass, as the port should be publicly available to any service on the internet."),(0,a.kt)("p",null,"\u2728 If everything looks good, you have successfully migrated to the Ursa-proxy from NGINX."),(0,a.kt)("h2",{id:"native"},"Native"),(0,a.kt)("p",null,"On earlier versions of our Native setup, an NGINX service was included, as the reverse proxy for the Ursa service. Plus, required during the SSL/TLS Certbot certification process to secure the domain name, that the process relied on."),(0,a.kt)("p",null,"Since the introduction of Ursa-proxy in our Ursa repository, and the related support added from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fleek-network/get.fleek.network/commit/0afa813ab74eaf15d50ad126d0534bbe0a14aed9"},"Ursa-proxy")," configuration in the assisted installer that the Ursa-proxy is now the default reverse proxy in the Native setup."),(0,a.kt)("p",null,"If you have set up a node before these features, you'll have NGINX declared and stored in your file system."),(0,a.kt)("p",null,"We'll look into:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Setup the Ursa-proxy",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Pull the latest from source repository"),(0,a.kt)("li",{parentName:"ul"},"Build from source"),(0,a.kt)("li",{parentName:"ul"},"Create the ",(0,a.kt)("inlineCode",{parentName:"li"},".ursa")," proxy configuration"),(0,a.kt)("li",{parentName:"ul"},"Create the certificates directories"),(0,a.kt)("li",{parentName:"ul"},"Create a systemd service"))),(0,a.kt)("li",{parentName:"ul"},"Generate the TLS certifications"),(0,a.kt)("li",{parentName:"ul"},"Clean up (remove the NGINX files)"),(0,a.kt)("li",{parentName:"ul"},"Do a health check")),(0,a.kt)("h3",{id:"setup-the-ursa-proxy-1"},"Setup the Ursa proxy"),(0,a.kt)("p",null,"Change the working directory to where you have saved the Ursa repository, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("h4",{id:"1-pull-the-latest-version-of-the-source-code-1"},"1) Pull the latest version of the source code"),(0,a.kt)("p",null,"Switch to the main branch"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git checkout main\n")),(0,a.kt)("p",null,"Run the following command to pull the latest commits from ",(0,a.kt)("inlineCode",{parentName:"p"},"origin/main"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git pull origin main\n")),(0,a.kt)("p",null,"\u26a0\ufe0f If this fails, due to any of the possible several reasons, e.g. handling staged or local changes, having to discard changes, or saving changes, check the ",(0,a.kt)("a",{parentName:"p",href:"https://git-scm.com/doc"},"git documentation")," to learn the basics."),(0,a.kt)("h3",{id:"build-the-ursa-proxy-from-source"},"Build the Ursa proxy from source"),(0,a.kt)("p",null,"The Ursa proxy is available as a ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fleek-network/ursa/tree/main/crates/ursa-proxy"},"crate")," in the source repository. You'll have to build from source every time a new update is available to have an executable. Also, create the configuration file, ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Systemd"},"systemd")," service, etc. This can take some time to get right, for this reason, we provide an install script to automate the processes."),(0,a.kt)("p",null,"You have two options! Either build from the source by running the install script or do it manually by following the instructions."),(0,a.kt)("h4",{id:"run-the-ursa-proxy-install-script"},"Run the Ursa proxy install script"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"curl https://get.fleek.network/install_ursa_proxy | bash\n")),(0,a.kt)("p",null,"\u2728 Once completed you can move on to the next step! You are not required to follow the manual setup installation instructions."),(0,a.kt)("h4",{id:"manual-setup"},"Manual setup"),(0,a.kt)("h4",{id:"1-run-the-install-command"},"1) Run the install command"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cargo install --path crates/ursa-proxy\n")),(0,a.kt)("p",null,"It should install the executable ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy")," in ",(0,a.kt)("inlineCode",{parentName:"p"},".cargo/bin/ursa-proxy"),"."),(0,a.kt)("p",null,"\ud83d\udca1 Your Rust setup should've included the ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.cargo/bin/ursa-proxy")," in the system PATH environment variable, making the executable available globally. If you haven't or have a preference to keep your binaries in your local bin you can run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ln -s $HOME/.cargo/bin/ursa-proxy /usr/local/bin/ursa-proxy\n")),(0,a.kt)("p",null,"Confirm that is available globally"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ursa-proxy --version\n")),(0,a.kt)("p",null,"You should get a response similar to"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ursa-proxy x.x.x\n")),(0,a.kt)("h4",{id:"2-create-a-systemd-service-for-the-ursa-proxy"},"2) Create a Systemd service for the Ursa proxy"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"touch /etc/systemd/system/ursa-proxy.service\n")),(0,a.kt)("p",null,"\ud83d\udca1 If you don't have permissions, you may have to use ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo"),", e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo touch /etc/systemd/system/ursa-proxy.service")),(0,a.kt)("p",null,"Set the file permissions for ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy.service")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo chmod 644 /etc/systemd/system/ursa-proxy.service\n")),(0,a.kt)("p",null,"Create the directory where the log (STDOUT) and diagnostic (STDERR) files will be saved."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mkdir -p /var/log/ursa-proxy\n")),(0,a.kt)("p",null,"Create the file output.log"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"touch /var/log/ursa-proxy/output.log\n")),(0,a.kt)("p",null,"Create the file diagnostic.log"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"touch /var/log/ursa-proxy/diagnostic.log\n")),(0,a.kt)("p",null,"Set the file permissions for the Ursa proxy logs recursively"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo chmod -R 644 /var/log/ursa-proxy\n")),(0,a.kt)("p",null,"\ud83d\udca1 If you don't have permissions, you may have to use ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo"),", e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo touch /var/log/ursa-proxy/output.log")),(0,a.kt)("p",null,"Open the file ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy.service")," in your favorite text editor and put the following content inside"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[Unit]\nDescription=Ursa-proxy, for the Decentralized Content Delivery Network (DCDN)\n\n[Service]\nType=simple\nMemoryHigh=1G\nRestartSec=15s\nRestart=always\nExecStart=ursa-proxy daemon\nStandardOutput=append:/var/log/ursa-proxy/output.log\nStandardError=append:/var/log/ursa-proxy/diagnostic.log\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("p",null,"\u26a0\ufe0f Warning for property value in ",(0,a.kt)("inlineCode",{parentName:"p"},"ExecStart"),", if you haven't symlink the ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.cargo/bin/ursa-proxy")," -> ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/ursa-proxy"),", use the absolute path to the executable, e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"/root/.cargo/bin/ursa-proxy daemon")," which would look like ",(0,a.kt)("inlineCode",{parentName:"p"},"ExecStart=/root/.cargo/bin/ursa-proxy daemon")),(0,a.kt)("p",null,"Reload the system control daemon"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl daemon-reload\n")),(0,a.kt)("p",null,"\u2728 The service was built and set up as a Systemd service!"),(0,a.kt)("h3",{id:"create-the-ursa-proxy-configuration"},"Create the Ursa proxy configuration"),(0,a.kt)("p",null,"The Ursa proxy requires a configuration where the certificate's path is declared, among other properties such as the proxy pass and listener address, etc."),(0,a.kt)("p",null,"\u26a0\ufe0f Warning, we're assuming that you run Ursa with an administrative account such as ",(0,a.kt)("inlineCode",{parentName:"p"},"sudoer")," user, for this reason, ",(0,a.kt)("inlineCode",{parentName:"p"},".ursa")," is assumed to be in ",(0,a.kt)("inlineCode",{parentName:"p"},"/root")," as follows ",(0,a.kt)("inlineCode",{parentName:"p"},"/root/.ursa"),". If you have changed file permissions and setup, use the correct path."),(0,a.kt)("h4",{id:"1-create-the-proxy-directory-where-the-config-file-for-ursa-proxy-will-be"},"1) Create the proxy directory where the config file for ursa-proxy will be:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mkdir -p /root/.ursa/proxy\n")),(0,a.kt)("p",null,"\ud83d\udca1 If you don't have permissions, use ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo")," e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo mkdir -p /root/.ursa/proxy")),(0,a.kt)("h4",{id:"2-create-the-ursa-proxy-configtoml"},"2) Create the Ursa proxy ",(0,a.kt)("inlineCode",{parentName:"h4"},"config.toml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"touch /root/.ursa/proxy/config.toml\n")),(0,a.kt)("p",null,"Open the ",(0,a.kt)("inlineCode",{parentName:"p"},"/root/.ursa/proxy/config.toml")," in your favorite text editor and put the following content in the ",(0,a.kt)("inlineCode",{parentName:"p"},"config.toml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'# Server without TLS.\n[[server]]\nproxy_pass = "127.0.0.1:4069"\nlisten_addr = "0.0.0.0:80"\nserve_dir_path = ".well-known"\n\n# Server with TLS\n[[server]]\nproxy_pass = "127.0.0.1:4069"\nlisten_addr = "0.0.0.0:443"\n\n[server.tls]\ncert_path = "/etc/letsencrypt/live/YOUR-DOMAIN/fullchain.pem"\nkey_path = "/etc/letsencrypt/live/YOUR-DOMAIN/privkey.pem"\n\n# Admin service.\n# You can omit this section as this is the default.\n[admin]\naddr = "0.0.0.0:8881"\n')),(0,a.kt)("p",null,"Find and replace ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR-DOMAIN")," with your domain name. That'll be the values for the property ",(0,a.kt)("inlineCode",{parentName:"p"},"cert_path")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"key_path"),", e.g. let's say that your domain name is ",(0,a.kt)("inlineCode",{parentName:"p"},"node.domain.com"),", you'd replace ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR-DOMAIN")," to have:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'[server.tls]\ncert_path = "/etc/letsencrypt/live/node.domain.com/fullchain.pem"\nkey_path = "/etc/letsencrypt/live/node.domain.com/privkey.pem"\n')),(0,a.kt)("h3",{id:"generate-the-tls-certificates-1"},"Generate the TLS Certificates"),(0,a.kt)("p",null,"Change the directory to where the Ursa project is located, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("p",null,"Then, you have two options! Either run the Lets Encrypt install script we provide to automate the process for you or follow the instructions in the guide."),(0,a.kt)("h4",{id:"run-the-lets-encrypt-install-script"},"Run the Lets Encrypt install script"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"curl https://get.fleek.network/lets_encrypt | bash\n")),(0,a.kt)("p",null,"\u2728 Once completed you can move on to the next step! You are not required to follow the steps to install the TLS Certificates manually."),(0,a.kt)("h4",{id:"manual"},"Manual"),(0,a.kt)("h4",{id:"1-close-any-processes-running-on-port-80-1"},"1) Close any processes running on port 80"),(0,a.kt)("p",null,"Find the PID of processes"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"lsof -i :80\n")),(0,a.kt)("p",null,"If port 80 is in use, you'll get a table similar to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"COMMAND PID   USER   FD   TYPE  DEVICE  SIZE/OFF  NODE NAME\nfoobar  88493 root   11u  IPv4  6545735      0t0  TCP  *:http (LISTEN)\n")),(0,a.kt)("p",null,"Stop the process by name of PID"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"kill -9 <PID>\n")),(0,a.kt)("p",null,"\ud83d\udca1 Replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<PID>")," with the numerical value that corresponds to the process"),(0,a.kt)("p",null,"For example, given the table result the PID is 88493"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"kill -9 88493\n")),(0,a.kt)("p",null,"To complete, confirm there aren't any processes running on port 80 by running the command again"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"lsof -i :80\n")),(0,a.kt)("p",null,"The response should be empty!"),(0,a.kt)("h4",{id:"2-confirm-that-the-domain-name-is-pointing-to-the-servers-public-ip-address"},"2) Confirm that the domain name is pointing to the server's public IP address"),(0,a.kt)("p",null,"We are assuming that you have your domain name pointing to the server public IP address since you are migrating NGINX to Ursa-proxy. But if you're at the same time changing the domain name address that points to your server, or haven't done it, you have to open the domain name registrar dashboard and update the record type A records and set the domain name to respond with the server public IP Address."),(0,a.kt)("p",null,"For example, let's say that your domain name is ",(0,a.kt)("inlineCode",{parentName:"p"},"node.example.com")," and your server's public IP address is ",(0,a.kt)("inlineCode",{parentName:"p"},"181.196.118.156"),", this is how it'd look hypothetically:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Type"),(0,a.kt)("th",{parentName:"tr",align:null},"Host"),(0,a.kt)("th",{parentName:"tr",align:null},"Answer"),(0,a.kt)("th",{parentName:"tr",align:null},"TTL"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"A"),(0,a.kt)("td",{parentName:"tr",align:null},"node.example.com"),(0,a.kt)("td",{parentName:"tr",align:null},"181.196.118.156"),(0,a.kt)("td",{parentName:"tr",align:null},"300")))),(0,a.kt)("p",null,"Once you have ",(0,a.kt)("a",{parentName:"p",href:"#how-to-set-up-the-dns-settings-for-a-node-server"},"set up the DNS records"),", verify the records are set correctly, for that you can easily run ",(0,a.kt)("inlineCode",{parentName:"p"},"dig")," CLI or a website like ",(0,a.kt)("a",{parentName:"p",href:"https://mxtoolbox.com/"},"mxtoolbox"),"](",(0,a.kt)("a",{parentName:"p",href:"https://mxtoolbox.com/"},"https://mxtoolbox.com/"),")."),(0,a.kt)("p",null,"For our example, we're going to use the ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Dig_(command)"},"dig")," CLI."),(0,a.kt)("p",null,"\ud83d\udca1 If you don't have ",(0,a.kt)("inlineCode",{parentName:"p"},"dig")," installed, you can use your operating system package manager to install it, e.g. in Ubuntu, you can run ",(0,a.kt)("inlineCode",{parentName:"p"},"apt-get install dig")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"dig node.example.com +nostats +nocomments +nocmd\n")),(0,a.kt)("p",null,"In the response, we get the IP address 181.196.118.156, as declared in the domain name registrar dashboard. Be aware that DNS propagation may take some time, if you need help troubleshooting check our reference ",(0,a.kt)("a",{parentName:"p",href:"../../reference/DNS/domain-name-system-nameserver-troubleshooting"},"DNS troubleshooting"),". "),(0,a.kt)("p",null,"\u26a0\ufe0f Your server DNS resolver, should get the correct data otherwise the certification process will fail!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},";node.example.com.      IN  A\nnode.example.com.       484 IN  A   181.196.118.156\n")),(0,a.kt)("p",null,"There are many other tools you can use to verify the DNS records, feel free to pick your favorite!"),(0,a.kt)("h4",{id:"3-create-the-certificates"},"3) Create the certificates"),(0,a.kt)("p",null,"Execute the command which will start a standalone web server on port 80 of your host."),(0,a.kt)("p",null,"\ud83d\udca1 Find and replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<YOUR-VALID-EMAIL-ADDRESS>")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"<YOUR-VALID-DOMAIN-NAME>")," with your email address and domain name. The email address is for administration purposes by ",(0,a.kt)("a",{parentName:"p",href:"https://letsencrypt.org/"},"Let's Encrypt org"),", we don't store any of your data."),(0,a.kt)("p",null,'We\'re using backslashes "\\" to break the lines to make it easier to read, you can ignore them.'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"sudo certbot certonly \\\n    --standalone \\\n    --preferred-challenges http \\\n    --email <YOUR-VALID-EMAIL-ADDRESS> \\\n    --domain <YOUR-VALID-DOMAIN-NAME> \\\n    --rsa-key-size 4096 \\\n    --agree-tos -n\n")),(0,a.kt)("p",null,"For example, let's say that your email is \"",(0,a.kt)("a",{parentName:"p",href:"mailto:skywalker@example.com"},"skywalker@example.com"),'" and  domain "node.domain.com", it\'d look like this:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"sudo certbot certonly \\\n    --standalone \\\n    --preferred-challenges http \\\n    --email skywalker@example.com \\\n    --domain node.domain.com \\\n    --rsa-key-size 4096 \\\n    --agree-tos -n\n")),(0,a.kt)("p",null,'Once executed and if all goes well, you should get a "success" message similar to:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"Domains: node.example.com\nCreating full-node_certbot_run ... done\nGenerating a RSA private key\n...........................................++++\n......................................................................................................................................................................................................++++\nwriting new private key to '/etc/letsencrypt/live/node.example.com/privkey.pem'\n-----\n\nCreating full-node_certbot_run ... done\nSaving debug log to /var/log/letsencrypt/letsencrypt.log\nRequesting a certificate for node.example.com\n\nSuccessfully received certificate.\nCertificate is saved at: /etc/letsencrypt/live/node.example.com/fullchain.pem\nKey is saved at:         /etc/letsencrypt/live/node.example.com/privkey.pem\nThis certificate expires on 2023-04-25.\nThese files will be updated when the certificate renews.\n\nNEXT STEPS:\n- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to enable that functionality. See https://certbot.org/renewal-setup for instructions.\n\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nIf you like Certbot, please consider supporting our work by:\n * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate\n * Donating to EFF:                    https://eff.org/donate-le\n")),(0,a.kt)("p",null,'\ud83d\udca1 Notice the "Successfully received certificate", where it\'s saved at "/etc/letsencrypt/live/node.example.com", the "This certificate expires on 2023-04-25" and any other details you might find interesting.'),(0,a.kt)("h4",{id:"4-start-the-ursa-proxy"},"4) Start the Ursa proxy"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"sudo systemctl start ursa-proxy\n")),(0,a.kt)("p",null,"If the ursa-proxy was already running, you could reload the TLS Configuration only and not have to restar the service, as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"curl -X POST 0.0.0.0:8881/reload-tls-config\n")),(0,a.kt)("h3",{id:"quick-health-check-1"},"Quick health check"),(0,a.kt)("p",null,"The working directory should be the Ursa project source code location, e.g. by default ",(0,a.kt)("inlineCode",{parentName:"p"},"~/fleek-network/ursa"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd ~/fleek-network/ursa\n")),(0,a.kt)("h4",{id:"1-check-ursa-and-ursa-proxy-services-status"},"1) Check Ursa and Ursa Proxy services status"),(0,a.kt)("p",null,"You can check the current status by running the command for ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa.service")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"sudo systemctl status ursa\n")),(0,a.kt)("p",null,"Or, the command for ",(0,a.kt)("inlineCode",{parentName:"p"},"ursa-proxy.service")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"sudo systemctl status ursa-proxy\n")),(0,a.kt)("p",null,"The response should be similar to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u25cf ursa-proxy.service - Ursa-proxy, for the Decentralized Content Delivery Network (DCDN)\n     Loaded: loaded (/etc/systemd/system/ursa-proxy.service; enabled; vendor preset: enabled)\n     Active: active (running) since Fri 2023-04-28 12:38:54 UTC; 5h 22min ago\n   Main PID: 88493 (ursa-proxy)\n      Tasks: 17 (limit: 19153)\n     Memory: 3.8M (high: 1.0G available: 1020.1M)\n        CPU: 17.830s\n     CGroup: /system.slice/ursa-proxy.service\n             \u2514\u250088493 ursa-proxy daemon\n")),(0,a.kt)("p",null,"Notice that the response status above, says that it's active"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Active: active (running) since Fri 2023-04-28 12:38:54 UTC; 5h 22min ago\n")),(0,a.kt)("h4",{id:"2-start-the-ursa-and-ursa-proxy-services"},"2) Start the Ursa and Ursa-proxy services"),(0,a.kt)("p",null,"If the status of the services are not running you start the service(s) by running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl start ursa\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl start ursa-proxy\n")),(0,a.kt)("p",null,"If you run the ",(0,a.kt)("inlineCode",{parentName:"p"},"status")," command from then on, it should be ",(0,a.kt)("inlineCode",{parentName:"p"},"active (running)"),"."),(0,a.kt)("h4",{id:"3-run-a-health-check"},"3) Run a health check"),(0,a.kt)("p",null,"As instructed in the ",(0,a.kt)("a",{parentName:"p",href:"fleek-network-node-health-check-guide"},"guide"),", we can do a quick health check by making ",(0,a.kt)("inlineCode",{parentName:"p"},"cURL")," requests to our server and reading the response. There's the option to get the response body that should be text ",(0,a.kt)("inlineCode",{parentName:"p"},"pong")," or get some HTTP Headers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'curl -w "\\n" https://<YOUR DOMAIN NAME>/ping\n')),(0,a.kt)("p",null,"For our example, we have the domain ",(0,a.kt)("inlineCode",{parentName:"p"},"node.domain.com")," and this is how the ",(0,a.kt)("inlineCode",{parentName:"p"},"cURL")," request would look like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'curl -w "\\n" https://node.domain.com/ping\n')),(0,a.kt)("p",null,"A successful response should be ",(0,a.kt)("inlineCode",{parentName:"p"},"pong")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"pong\n")),(0,a.kt)("p",null,"Use the flag ",(0,a.kt)("inlineCode",{parentName:"p"},"-I")," to get the HTTP Headers. To learn more read the guide ",(0,a.kt)("a",{parentName:"p",href:"fleek-network-node-health-check-guide"},"here"),"."),(0,a.kt)("p",null,"You can do these tests from any remote location that is not your server or local machine and the health check should pass, as the port should be publicly available to any service on the internet."),(0,a.kt)("p",null,"\u2728 If everything looks good, you have successfully migrated to the Ursa-proxy from NGINX."),(0,a.kt)("h3",{id:"clear-nginx"},"Clear NGINX"),(0,a.kt)("p",null,"We'll assume that your use case is the Fleek Network node and that the NGINX server only has the node setup and no other services or sites. If that's the case, you'd want to uninstall and purge NGINX."),(0,a.kt)("p",null,"Clearing NGINX will depend if you're using it for anything else than Ursa setup. If your only use case is ursa, you can go ahead and uninstall and purge NGINX, otherwise for users who have multiple sites or web services then you should disable the Ursa NGINX site configuration."),(0,a.kt)("p",null,"Here's how you'd uninstall and purge NGINX"),(0,a.kt)("p",null,"Stop the NGINX service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl stop nginx\n")),(0,a.kt)("p",null,"Purge everything (including all config files data)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo apt purge nginx nginx-common nginx-core\n")),(0,a.kt)("p",null,"On the other hand, if you have multiple sites configured, make sure that you take the required cautions to avoid breaking your sites or web services."),(0,a.kt)("p",null,"Disable the NGINX Ursa site by removing the symlinks for the Ursa configurations."),(0,a.kt)("p",null,"Delete the HTTP configuration symlink"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rm /etc/nginx/sites-enabled/ursa-http.conf\n")),(0,a.kt)("p",null,"Delete the HTTPS configuration symlink"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rm /etc/nginx/sites-enabled/ursa-https.conf\n")),(0,a.kt)("p",null,"Remove the NGINX Ursa configuration files, as you won't need these any longer."),(0,a.kt)("p",null,"Delete the HTTP configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rm /etc/nginx/sites-available/ursa-http.conf\n")),(0,a.kt)("p",null,"Delete the HTTPS configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rm /etc/nginx/sites-available/ursa-https.conf\n")),(0,a.kt)("p",null,"Reload NGINX"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl reload nginx\n")),(0,a.kt)("p",null,"\u26a0\ufe0f Bear in mind that the Lets Encrypt Certbot process requires port 80 to be free, otherwise it'll fail if you wish to auto-renew or create new certificates"),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"Fleek Network processes don't have to be fully exposed to the world, to prevent some of the concerns in that regard and networking security, we have a reverse proxy to offer us a bit of control. A reverse proxy helps prevent users from connecting to the server processes directly, reducing the number of entry points and interactions from external actors."),(0,a.kt)("p",null,"On early builds, the NGINX Service was included as a Docker Service, or as a service in your host operating system. As we build the project, there is a need to provide better control and customization which lead to building our reverse proxy implementation that mimics some of the features offered by NGINX with a smaller footprint."),(0,a.kt)("p",null,"The guide illustrates the steps required to migrate to Ursa proxy from NGINX in either Docker Stack or Native."),(0,a.kt)("p",null,"Discover more about the project by ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fleek-network/ursa"},"watching/contributing on Github"),", following us on ",(0,a.kt)("a",{parentName:"p",href:"https://twitter.com/fleek_net"},"Twitter"),", and joining ",(0,a.kt)("a",{parentName:"p",href:"https://discord.gg/fleekxyz"},"our community Discord")," for all the best updates!"),(0,a.kt)(o.Z,{name:"Helder Oliveira",image:"https://github.com/heldrida.png",title:"Software Developer + DX",url:"https://github.com/heldrida",mdxType:"Author"}))}d.isMDXComponent=!0},3872:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(7294);const a=e=>{let{image:t,name:r,title:a,url:o}=e;return n.createElement("section",{className:"author_card"},n.createElement("div",null,n.createElement("span",{className:"avatar"},n.createElement("a",{href:o,target:"_blank",alt:r},n.createElement("img",{src:t,alt:r}))),n.createElement("div",null,n.createElement("span",{className:"name"},n.createElement("a",{href:o,target:"_blank",alt:r},r)),n.createElement("span",{className:"title"},a),n.createElement("span",{className:"discord"},"Got questions? Find us on ",n.createElement("a",{href:"https://discord.gg/fleekxyz",target:"_blank"},"Discord!")))))}},8249:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/fleek-network-migrate-to-ursa-proxy-from-nginx-8e0fef65fa65a7bc74f4a255cefbf938.png"}}]);