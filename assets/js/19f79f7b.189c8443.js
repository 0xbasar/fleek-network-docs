"use strict";(self.webpackChunkdocta=self.webpackChunkdocta||[]).push([[8489],{3905:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>m});var n=o(7294);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function i(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?i(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var s=n.createContext({}),u=function(e){var t=n.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):r(r({},t),e)),o},c=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(o),p=a,m=d["".concat(s,".").concat(p)]||d[p]||g[p]||i;return o?n.createElement(m,r(r({ref:t},c),{},{components:o})):n.createElement(m,r({ref:t},c))}));function m(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=o.length,r=new Array(i);r[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:a,r[1]=l;for(var u=2;u<i;u++)r[u]=o[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,o)}p.displayName="MDXCreateElement"},3675:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var n=o(7462),a=(o(7294),o(3905)),i=o(3872);const r={title:"How to manage log files",hide_title:!0,slug:"how-to-manage-log-files",date:new Date("2023-10-27T12:00:00.000Z"),image:"./assets/managing-the-keystore.png?202311181211",description:"Learn how to rotate, compress the log files",category:"Tutorial",tags:["guide","logs"]},l=void 0,s={unversionedId:"Node Operators/how-to-manage-logfiles",id:"Node Operators/how-to-manage-logfiles",title:"How to manage log files",description:"Learn how to rotate, compress the log files",source:"@site/guides/Node Operators/how-to-manage-logfiles.md",sourceDirName:"Node Operators",slug:"/Node Operators/how-to-manage-log-files",permalink:"/guides/Node Operators/how-to-manage-log-files",draft:!1,editUrl:"https://github.com/fleek-network/fleek-network-docs/edit/main/guides/Node Operators/how-to-manage-logfiles.md",tags:[{label:"guide",permalink:"/guides/tags/guide"},{label:"logs",permalink:"/guides/tags/logs"}],version:"current",lastUpdatedAt:1698670076,formattedLastUpdatedAt:"Oct 30, 2023",frontMatter:{title:"How to manage log files",hide_title:!0,slug:"how-to-manage-log-files",date:"2023-10-27T12:00:00.000Z",image:"./assets/managing-the-keystore.png?202311181211",description:"Learn how to rotate, compress the log files",category:"Tutorial",tags:["guide","logs"]},sidebar:"defaultSidebar",previous:{title:"Getting Started",permalink:"/guides/Node Operators/getting-started"},next:{title:"Managing the keystore",permalink:"/guides/Node Operators/managing-the-keystore"}},u={image:o(4350).Z},c=[{value:"Introduction",id:"introduction",level:2},{value:"Journal",id:"journal",level:2},{value:"Commands",id:"commands",level:3},{value:"Disk utilization checkup",id:"disk-utilization-checkup",level:4},{value:"Clearing logs manually",id:"clearing-logs-manually",level:4},{value:"Follow or tail logs of service",id:"follow-or-tail-logs-of-service",level:4},{value:"Show all service entries",id:"show-all-service-entries",level:4},{value:"Configuration file",id:"configuration-file",level:3},{value:"Create the directory and config file",id:"create-the-directory-and-config-file",level:3},{value:"Configuration settings",id:"configuration-settings",level:3},{value:"Logrotate",id:"logrotate",level:2},{value:"Prerequesite",id:"prerequesite",level:3},{value:"Explore the Configuration files",id:"explore-the-configuration-files",level:3},{value:"Create the Lightning logrotate configuration file",id:"create-the-lightning-logrotate-configuration-file",level:3},{value:"Lightning Configuration Settings",id:"lightning-configuration-settings",level:3},{value:"Cron job",id:"cron-job",level:3},{value:"Conclusion",id:"conclusion",level:2}],d={toc:c},g="wrapper";function p(e){let{components:t,...r}=e;return(0,a.kt)(g,(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"How to manage log files",src:o(5407).Z,width:"1450",height:"816"})),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"The Fleek Network node streams text messages to the standard output and error in Linux. Given that disk space is a limited resource for most systems, the number of text data can be a cause of concern. Managing the file sizes by means of rotation and compression can help."),(0,a.kt)("p",null,"A conventional Fleek Network Service setup (as per the documentation and tool recommendations), have the text data stored in a special directory for storing logs called /var/log. The /var/log directory contains logs from various applications running on the operating system, the operating system itself, and others."),(0,a.kt)("p",null,"For the purpose of storing network node operation logs, it defaults to the /var/log/lightning directory where the files output.log (stdout) and diagnostic.log (stderr) is located and accumulated. As the node runs, the size of the files increase, as it aggregates all the output generated by the Fleek Network service operations, such as info, errors, etc."),(0,a.kt)("p",null,"A Node Operator can configure the system to rotate, compress, and set maximum size of these files to safeguard any concerns or issues that can get out of control, such as causing disk space to become full quickly."),(0,a.kt)("p",null,"In this guide, we'll look into some options available to manage the logs. First, we'll look into journald.conf which controls where to store journal data (the journal is a component of systemd that handles all the messages in a Systemd enabled system). Afterwards, we'll look into ",(0,a.kt)("a",{parentName:"p",href:"https://linux.die.net/man/8/logrotate"},"Logrotate")," an application to help us manage automatic rotation and compression of log files."),(0,a.kt)("p",null,"In essence, the journal and the logs duplicate the same information, and we want to make sure that we set measures to control it."),(0,a.kt)("h2",{id:"journal"},"Journal"),(0,a.kt)("p",null,"Journal is a component of Systemd, a centralized location for all messages logged by different components in a systemd-enabled Linux system. The systemd journal will happily run in parallel with the standard type log files in ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/log/*")," where the Fleek Network Systemd Unit Service outputs Standard Output and Standard Error in the location ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/log/lightning/*.log"),"."),(0,a.kt)("p",null,"Here, we are going to learn how to configure the ",(0,a.kt)("inlineCode",{parentName:"p"},"journald.conf")," service configuration file for the system-wide settings (meaning that it applies to all services), but firstly we're going to learn some commands to help us troubleshoot when necessary."),(0,a.kt)("h3",{id:"commands"},"Commands"),(0,a.kt)("h4",{id:"disk-utilization-checkup"},"Disk utilization checkup"),(0,a.kt)("p",null,"To check how much disk space is used by Systemd log files, run the command below:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl --disk-usage\n")),(0,a.kt)("p",null,"It provides information of how much disk space is utilized by the log files in your system."),(0,a.kt)("h4",{id:"clearing-logs-manually"},"Clearing logs manually"),(0,a.kt)("p",null,"The best way to clear log files is done automatically by the ",(0,a.kt)("inlineCode",{parentName:"p"},"journald.conf")," configuration file, discussed in ",(0,a.kt)("a",{parentName:"p",href:"#configuration-file"},"Configuration file"),". In the ideal world, you shouldn't have to manually delete the log files, but this can be useful to know about when troubleshooting."),(0,a.kt)("p",null,"To ",(0,a.kt)("inlineCode",{parentName:"p"},"flush")," the log files run the command below:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl --flush --rotate\nsudo journalctl --vacuum-time=1s\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"The flush and rotate flag is used, as vaccum-time only clears archived logs and not active ones. It'll flush:"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"Move /run/log/journal to /var/log/journal"),(0,a.kt)("li",{parentName:"ul"},"Rotate (this flag archives logs and retains it)")),(0,a.kt)("p",{parentName:"admonition"},"Since it'll only keep the past 1-second-long files, it'll effectively clear everything.")),(0,a.kt)("h4",{id:"follow-or-tail-logs-of-service"},"Follow or tail logs of service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl -u <SERVICE-NAME>.service -f\n")),(0,a.kt)("p",null,"For example, for a conventional native install (if you haven't followed the conventions, make the appropriate tweaks to fit your needs)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl -u lightning.service -f\n")),(0,a.kt)("p",null,"The Docker service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl -u docker-lightning.service -f\n")),(0,a.kt)("h4",{id:"show-all-service-entries"},"Show all service entries"),(0,a.kt)("p",null,"Show all journal entries, which can be fairly long:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl\n")),(0,a.kt)("h3",{id:"configuration-file"},"Configuration file"),(0,a.kt)("p",null,"The default configuration file is located at ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/systemd/journald.conf"),". This is the main file that journal reads the configuration from, for the system instances that are controlled by root."),(0,a.kt)("p",null,"In addition to the main configuration file there are a few other locations that take higher precedence and override the main configuration file. To learn more about journald read ",(0,a.kt)("a",{parentName:"p",href:"https://www.freedesktop.org/software/systemd/man/latest/journald.conf.html#Options"},"here"),"."),(0,a.kt)("p",null,"To keep the guide short we are going to use the main location ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/systemd/journald.conf"),"."),(0,a.kt)("h3",{id:"create-the-directory-and-config-file"},"Create the directory and config file"),(0,a.kt)("p",null,"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/systemd/journald.conf")," file doesn't exist, create it by:"),(0,a.kt)("p",null,"Create the ",(0,a.kt)("inlineCode",{parentName:"p"},"journald.conf")," file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo touch /etc/systemd/journald.conf\n")),(0,a.kt)("h3",{id:"configuration-settings"},"Configuration settings"),(0,a.kt)("p",null,"The Systemd provides many options for you to manage the log files and by combining these parameters you can limit the disk space used by the journal files."),(0,a.kt)("p",null,"A list of the available options are ",(0,a.kt)("a",{parentName:"p",href:"https://www.freedesktop.org/software/systemd/man/latest/journald.conf.html#Options"},"here"),"."),(0,a.kt)("p",null,"Here is a quick description of the options we're going to use for our example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Storage"),", controls where to store journal data\t"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"SystemMaxUse"),", specifies the maximum disk space that can be used by the journal in persistent storage"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"SystemMaxFileSize"),", controls how large individual journal files can grow to in persistent storage before being rotated"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"RuntimeMaxUse"),", control how much disk space the journal may use up at most")),(0,a.kt)("p",null,"You should open the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/systemd/journald.conf")," file in your favorite text editor and put:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-toml"},"[Journal]\nStorage=persistent\nSystemMaxUse=100M\nSystemMaxFileSize=100M\nRuntimeMaxUse=100M\n")),(0,a.kt)("p",null,"Here, we set 100M, which means 100 Megabytes. You can also use K for Kbytes, G for Gbytes, amongst others."),(0,a.kt)("p",null,"After the changes, you have to restart the journald after updating the file. To restart use the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl restart systemd-journald\n")),(0,a.kt)("p",null,"You can verify the integrity of the log files by running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo journalctl --verify\n")),(0,a.kt)("h2",{id:"logrotate"},"Logrotate"),(0,a.kt)("p",null,"Logrotate is a tool to manage the log files created by a system processes. It can automatically compress, rename, remove logs and more for your convenience and save your system's resources. Log files can be handled timely, or when it grows too large."),(0,a.kt)("h3",{id:"prerequesite"},"Prerequesite"),(0,a.kt)("p",null,"The logrotate tools is available by default on Ubuntu."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"We're using Ubuntu for our guide to keep it simple. If you are using a different and support operating system make sure you install Logrotate before proceeding.")),(0,a.kt)("p",null,"You can check if logrotate is installed by executing:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"logrotate --version\n")),(0,a.kt)("p",null,"At the time this guide was written, we got the following output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"logrotate 3.21.0\n\n    Default mail command:       /usr/bin/mail\n    Default compress command:   /bin/gzip\n    Default uncompress command: /bin/gunzip\n    Default compress extension: .gz\n    Default state file path:    /var/lib/logrotate/status\n    ACL support:                yes\n    SELinux support:            yes\n")),(0,a.kt)("p",null,"If you run an earlier or older version, changes or tweaks might apply."),(0,a.kt)("h3",{id:"explore-the-configuration-files"},"Explore the Configuration files"),(0,a.kt)("p",null,"The configuration files we'll be exploring today are found in the following locations in Ubuntu:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"/etc/logrotate.conf"),", is the main configuration settings file. It includes the statement to pull in configuration files from other directories, e.g. the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.d"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"/etc/logrotate.d/"),", a directory where packages drop log rotation information"))),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"We use Ubuntu for our guide, if you are on a different distro, you have to determine the file configuration file locations")),(0,a.kt)("p",null,"The content of the file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.conf")," should be similar to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'# see "man logrotate" for details\n\n# global options do not affect preceding include directives\n\n# rotate log files weekly\nweekly\n\n# use the adm group by default, since this is the owning group\n# of /var/log/.\nsu root adm\n\n# keep 4 weeks worth of backlogs\nrotate 4\n\n# create new (empty) log files after rotating old ones\ncreate\n\n# use date as a suffix of the rotated file\n#dateext\n\n# uncomment this if you want your log files compressed\n#compress\n\n# packages drop log rotation information into this directory\ninclude /etc/logrotate.d\n\n# system-specific logs may also be configured here.\n')),(0,a.kt)("p",null,"The configuration settings if anything like the above, tell us that the rotation happens weekly, keeping 4 weeks worth of backlogs, etc."),(0,a.kt)("p",null,"To learn more about other configuration options consult the ",(0,a.kt)("a",{parentName:"p",href:"https://linux.die.net/man/8/logrotate"},"logrotate manual page"),"."),(0,a.kt)("h3",{id:"create-the-lightning-logrotate-configuration-file"},"Create the Lightning logrotate configuration file"),(0,a.kt)("p",null,"Let's create a Logrotate configuration file for Fleek Network Lightning Service. Create the file by running the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo touch /etc/logrotate.d/lightning\n")),(0,a.kt)("h3",{id:"lightning-configuration-settings"},"Lightning Configuration Settings"),(0,a.kt)("p",null,"Open the recently created file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.d/lightning")," in your favorite text editor."),(0,a.kt)("p",null,"Add the following lines to the file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"/var/log/lightning/*.log {\n    rotate 5\n    daily\n    size 50M\n    notifempty\n    compress\n}\n")),(0,a.kt)("p",null,"Remember to save the file before exiting the text editor. You can test the configuration file by running the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo logrotate /etc/logrotate.conf --debug\n")),(0,a.kt)("p",null,"The configuration file above declares that for the log files in the ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/log/lightning")," directory, the log files are rotated 5 times daily before being removed, as long they grow bigger than 50 megabytes in file size or empty. Old versions of log files are compressed with gzip."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Bear in mind that this configuration file also inherit the default behavior, e.g. the ",(0,a.kt)("inlineCode",{parentName:"p"},"create")," as set in the main configuration file ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.conf"),".")),(0,a.kt)("p",null,"Feel free to customize the settings to your liking by checking the documentation in the ",(0,a.kt)("a",{parentName:"p",href:"https://linux.die.net/man/8/logrotate"},"logrotate manual page"),"."),(0,a.kt)("h3",{id:"cron-job"},"Cron job"),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Depending on the operating system, you have to set up a cron job to execute logrotate with the configuration file daily. Since we are using Ubuntu for our example, a daily cron job runner is already set up for us. If you are on a different Distro/OS make the required amends.")),(0,a.kt)("p",null,"Verify that the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/cron.daily/logrotate")," exists and includes the execution of ",(0,a.kt)("inlineCode",{parentName:"p"},"logrotate")," with the configuration argument ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.conf"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"/usr/sbin/logrotate /etc/logrotate.conf\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"If you have modified the location of the binary or main configuration file, make sure this is set correctly to your custom locations.")),(0,a.kt)("p",null,"To summarize, the ",(0,a.kt)("inlineCode",{parentName:"p"},"logrotate /etc/logrotate.conf")," is executed and as logrotate.conf goes through its list of commands, it calls ",(0,a.kt)("inlineCode",{parentName:"p"},"include /etc/logrotate.d"),". It means that any scripts in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/logrotate.d")," are executed, such as the ",(0,a.kt)("a",{parentName:"p",href:"#lightning-configuration-settings"},"Lightning Configuration Settings"),"."),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"The guide starts by warning us about the stream text messages that the Fleek Network emits by default. As the text data is aggregated and stored in the file system it can lead to fill up the limited available disk space quickly, causing issues to the operation of the system."),(0,a.kt)("p",null,"To help control it, the journald is introduced, by explaining its role as a centralized message system, that runs alongside the application logs. Then, have it configured to limit the maximum file size, amongst other system-wide settings."),(0,a.kt)("p",null,"Finally, logrotate is discussed in helping us manage the Fleek Network Lightning application log files by setting it to automatically compress, rename, remove logs for the system admin convenience and saving system's resources."),(0,a.kt)(i.Z,{name:"Helder Oliveira",image:"https://github.com/heldrida.png",title:"Software Developer + DX",url:"https://github.com/heldrida",mdxType:"Author"}))}p.isMDXComponent=!0},3872:(e,t,o)=>{o.d(t,{Z:()=>a});var n=o(7294);const a=e=>{let{image:t,name:o,title:a,url:i,communityMember:r=!1}=e;return n.createElement("section",{className:"author_card"},n.createElement("div",null,n.createElement("span",{className:"avatar"},n.createElement("a",{href:i,target:"_blank",alt:o},n.createElement("img",{src:t,alt:o}))),n.createElement("div",null,n.createElement("span",{className:"name"},n.createElement("a",{href:i,target:"_blank",alt:o},o)),n.createElement("span",{className:"title"},a),n.createElement("span",{className:"discord"},r?"Join our community on":"Got questions? Find us on"," ",n.createElement("a",{href:"https://discord.gg/fleekxyz",target:"_blank"},"discord!")))))}},5407:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/how-to-manage-log-files-be3f38ea329523fb5ec346ee98946dbe.png"},4350:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/managing-the-keystore-fe4cdb19d2f59c54bcf864b0e069b535.png"}}]);